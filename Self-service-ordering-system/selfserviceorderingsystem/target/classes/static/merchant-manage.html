<!-- merchant-manage.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商家管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">奶茶店管理系统</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">欢迎，商家</span>
            </div>
        </div>
    </nav>

    <div class="row mt-4">
        <!-- 侧边栏 -->
        <div class="col-md-2">
            <div class="list-group">
                <button class="list-group-item list-group-item-action active" onclick="showProducts()">
                    商品管理
                </button>
                <button class="list-group-item list-group-item-action" onclick="showOrders()">
                    订单管理
                </button>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="col-md-10">
            <!-- 商品管理区域 -->
            <div id="product-section">
                <div class="d-flex justify-content-between mb-3">
                    <h3>商品管理</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        添加商品
                    </button>
                </div>

                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>描述</th>
                        <th>价格</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="product-table-body">
                    <!-- 商品数据将通过JS动态填充 -->
                    </tbody>
                </table>
            </div>

            <!-- 订单管理区域 -->
            <div id="order-section" style="display: none;">
                <h3>订单管理</h3>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>订单ID</th>
                        <th>用户ID</th>
                        <th>总金额</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="order-table-body">
                    <!-- 订单数据将通过JS动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 添加商品模态框 -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加商品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-product-form">
                    <div class="mb-3">
                        <label for="productName" class="form-label">商品名称</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">价格</label>
                        <input type="number" class="form-control" id="productPrice" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑商品模态框 -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑商品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-product-form">
                    <input type="hidden" id="editProductId">
                    <div class="mb-3">
                        <label for="editProductName" class="form-label">商品名称</label>
                        <input type="text" class="form-control" id="editProductName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editProductPrice" class="form-label">价格</label>
                        <input type="number" class="form-control" id="editProductPrice" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateProduct()">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 页面加载完成后获取商品数据
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
    });

    // 显示商品管理页面
    function showProducts() {
        document.getElementById('product-section').style.display = 'block';
        document.getElementById('order-section').style.display = 'none';
        loadProducts();
    }

    // 显示订单管理页面
    function showOrders() {
        document.getElementById('product-section').style.display = 'none';
        document.getElementById('order-section').style.display = 'block';
        loadOrders();
    }

    // 加载商品数据
    function loadProducts() {
        fetch('/api/merchant/products')
            .then(response => response.json())
            .then(response => {
                // 检查响应是否成功
                if (!response.success) {
                    console.error('Error loading products:', response.message);
                    return;
                }
                
                const data = response.data;
                const tbody = document.getElementById('product-table-body');
                tbody.innerHTML = '';

                data.forEach(product => {
                    const row = `
                            <tr>
                                <td>${product.id}</td>
                                <td>${product.name}</td>
                                <td>${product.description || ''}</td>
                                <td>¥${product.price.toFixed(2)}</td>
                                <td>${product.status === 1 ? '<span class="badge bg-success">上架</span>' : '<span class="badge bg-secondary">下架</span>'}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})">编辑</button>
                                    <button class="btn btn-sm ${product.status === 1 ? 'btn-outline-secondary' : 'btn-outline-success'}"
                                            onclick="toggleProductStatus(${product.id}, ${product.status === 1 ? 0 : 1})">
                                        ${product.status === 1 ? '下架' : '上架'}
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">删除</button>
                                </td>
                            </tr>
                        `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => console.error('Error loading products:', error));
    }

    // 添加商品
    function addProduct() {
        const product = {
            name: document.getElementById('productName').value,
            description: document.getElementById('productDescription').value,
            price: parseFloat(document.getElementById('productPrice').value),
            status: 1
        };

        fetch('/api/merchant/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(product)
        })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    alert(response.message);
                    document.getElementById('add-product-form').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    loadProducts();
                } else {
                    alert('添加失败: ' + (response.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error adding product:', error);
                alert('添加商品时发生错误: ' + error.message);
            });
    }

    // 编辑商品
    function editProduct(id) {
        fetch(`/api/merchant/products/${id}`)
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    const product = response.data;
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('editProductName').value = product.name;
                    document.getElementById('editProductDescription').value = product.description || '';
                    document.getElementById('editProductPrice').value = product.price;

                    const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                    modal.show();
                } else {
                    alert('获取商品信息失败: ' + (response.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error fetching product:', error);
                alert('获取商品信息时发生错误: ' + error.message);
            });
    }

    // 更新商品
    function updateProduct() {
        const id = document.getElementById('editProductId').value;
        const product = {
            name: document.getElementById('editProductName').value,
            description: document.getElementById('editProductDescription').value,
            price: parseFloat(document.getElementById('editProductPrice').value)
        };

        fetch(`/api/merchant/products/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(product)
        })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    alert(response.message);
                    bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                    loadProducts();
                } else {
                    alert('更新失败: ' + (response.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error updating product:', error);
                alert('更新商品时发生错误: ' + error.message);
            });
    }

    // 切换商品状态（上架/下架）
    function toggleProductStatus(id, status) {
        fetch(`/api/merchant/products/${id}/status?status=${status}`, {
            method: 'PUT'
        })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    alert(response.message);
                    loadProducts();
                } else {
                    alert('状态更新失败: ' + (response.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error updating product status:', error);
                alert('更新商品状态时发生错误: ' + error.message);
            });
    }

    // 删除商品
    function deleteProduct(id) {
        if (confirm('确定要删除这个商品吗？')) {
            fetch(`/api/merchant/products/${id}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(response => {
                    if (response.success) {
                        alert(response.message);
                        loadProducts();
                    } else {
                        alert('删除失败: ' + (response.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    alert('删除商品时发生错误: ' + error.message);
                });
        }
    }

    // 加载订单数据
    function loadOrders() {
        fetch('/api/merchant/orders')
            .then(response => response.json())
            .then(response => {
                if (!response.success) {
                    console.error('Error loading orders:', response.message);
                    alert('加载订单失败: ' + (response.message || '未知错误'));
                    return;
                }
                
                const data = response.data;
                const tbody = document.getElementById('order-table-body');
                tbody.innerHTML = '';

                data.forEach(order => {
                    let statusText = '';
                    let statusClass = '';

                    // 与客户页面保持一致的状态定义
                    switch(order.status) {
                        case 0:
                            statusText = '未支付';
                            statusClass = 'bg-warning';
                            break;
                        case 1:
                            statusText = '已支付';
                            statusClass = 'bg-info';
                            break;
                        case 2:
                            statusText = '已完成';
                            statusClass = 'bg-success';
                            break;
                        default:
                            statusText = '未知状态';
                            statusClass = 'bg-secondary';
                    }

                    const row = `
                            <tr>
                                <td>${order.id}</td>
                                <td>${order.userId}</td>
                                <td>¥${order.totalAmount.toFixed(2)}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                                <td>${new Date(order.createTime).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails(${order.id})">详情</button>
                                    ${order.status === 0 ?
                        `<button class="btn btn-sm btn-outline-success" onclick="updateOrderStatus(${order.id}, 1)">设为已支付</button>
                                         <button class="btn btn-sm btn-outline-danger" onclick="updateOrderStatus(${order.id}, 2)">取消订单</button>` :
                        (order.status === 1 ? 
                            `<button class="btn btn-sm btn-outline-success" onclick="updateOrderStatus(${order.id}, 2)">设为已完成</button>` :
                            '')}
                                </td>
                            </tr>
                        `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                alert('加载订单时发生错误: ' + error.message);
            });
    }

    // 更新订单状态
    function updateOrderStatus(id, status) {
        // 显示确认对话框
        let actionText = '';
        switch(status) {
            case 1:
                actionText = '设为已支付';
                break;
            case 2:
                actionText = '设为已完成';
                break;
            default:
                actionText = '更新状态';
        }
        
        if (!confirm(`确定要将订单 ${id} ${actionText} 吗？`)) {
            return;
        }
        
        fetch(`/api/merchant/orders/${id}/status?status=${status}`, {
            method: 'PUT'
        })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    alert(response.message);
                    loadOrders();
                } else {
                    alert('状态更新失败: ' + (response.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                alert('更新订单状态时发生错误: ' + error.message);
            });
    }

    // 查看订单详情
    function viewOrderDetails(id) {
        getOrderDetails(id);
    }

    // 获取订单详情
    function getOrderDetails(id) {
        fetch(`/api/merchant/orders/${id}`)
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    const orderData = response.data;
                    // 这里可以处理订单详情数据
                    alert(`订单 ${id} 的详情已获取`);
                } else {
                    alert('获取订单详情失败: ' + (response.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error fetching order details:', error);
                alert('获取订单详情时发生错误: ' + error.message);
            });
    }
</script>
</body>
</html>
